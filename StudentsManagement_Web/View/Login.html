<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>登录页面</title>
    <link href="../Content/bootstrap.css" rel="stylesheet" />
    <script type="text/javascript" src="../Scripts/jquery-3.3.1.js">
    </script>
    <script type="text/javascript" src="../Scripts/bootstrap.js"></script>
    <script type="text/javascript" src="../Scripts/CookieAbout.js"></script>
    <script type="text/javascript" src="../Scripts/AjaxAbout.js"></script>
    <style>
        .Logintable {
            text-align: center;
            width: auto;
            height: auto;
            margin: auto;
        }
        
        .TipFont {
            align-self: center;
            text-align: center;
        }
    </style>
    <style type="text/css">
        .TipFont {
            font: 300;
            color: darkorange;
            font-size: 25px;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-xs-12 col-md-4 col-md-offset-3 col-sm-4 col-sm-offset-3">
                <div class="TipFont">
                    请先登录！！!
                </div>
                <div class="input-group">
                    <span class="input-group-addon">账号：&nbsp;</span>
                    <input type="text" class="form-control" id="txtAccount" />
                </div>
                <div class="input-group">
                    <span class="input-group-addon">密码：&nbsp;</span>
                    <input type="password" class="form-control" id="txtPwd" />
                </div>
            </div>
            <div class="col-md-2 col-sm-2"></div>
            <div id="ValidateNum1" class="col-xs-12 col-md-4 col-md-offset-3 col-sm-4 col-sm-offset-3" style="display:none">
                <div class="input-group">
                    <span class="input-group-addon">验证码:</span>
                    <input type="text" class="form-control" id="txtValidateNum" />
                </div>
            </div>
            <div id="ValidateNum2" class="col-xs-12 col-md-4 col-sm-4" style="display:none">
                <p>
                    <img style="height: 100%;" onclick="getRandom()" id="NumImage" src="#" /> 请输入图片中验证码！
                </p>
            </div>
            <div class="col-xs-12 col-md-4 col-md-offset-3 col-sm-4 col-sm-offset-3 text-center">
                <div class="btn-group">
                    <input type="button" id="btnLogin" class='btn btn-success' onclick="Login()" value="登录" />
                    <input type="button" id="btnRegister" class="btn btn-success" onclick="Register()" value="注册" />
                </div>
            </div>
            <div class="col-md-2 col-sm-2"></div>
        </div>
    </div>

    <script>
        window.onload = function() {
            if (getCookie('islogin') == 'true') {
                location = 'Main.html';
            } else {
                if ((isExistCookie('times')) && (getCookie('times') != 'NaN')) {
                    if (getCookie('times') >= 5) {
                        $('#ValidateNum1').css('display', 'block');
                        $('#ValidateNum2').css('display', 'block');
                        getRandom();
                    }
                } else {
                    setCookie('times', 0);
                    $('#ValidateNum1').css('display', 'none');
                    $('#ValidateNum2').css('display', 'none');
                }
            }
            $('#txtAccount').bind('keyup', function(event) {
                if (event.keyCode == "13") {
                    $('#txtPwd').focus();
                }
            });
            $('#txtPwd').bind('keyup', function(event) {
                if (event.keyCode == "13") {
                    if ($('#ValidateNum1').css('display') != 'none') {
                        $('#txtValidateNum').focus();
                    } else {
                        Login();
                    }
                }
            });
            $('#txtValidateNum').bind('keyup', function(event) {
                if (event.keyCode == "13") {
                    Login();
                }
            });


        }

        function getRandom() {
            var pic = $('#NumImage');
            $.ajax({
                type: "get",
                url: "../api/Login?validate=0",
                success: function(sdata) {
                    var img = sdata;
                    pic.attr("src", "data:image/jpg;base64," + img);
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    ajaxError(XMLHttpRequest, textStatus);
                    var temp = parseInt(getCookie('times')) + 1;
                    deleteCookie('times');
                    setCookie('times', temp);
                    location = 'Login.html';
                }
            });
        }

        function Login() {
            $.ajax({
                type: "get",
                url: "../api/Login?t=true",
                success: function(data) {
                    var validate = "";
                    if ($('#ValidateNum1').css('display') == 'none') {
                        validate = data;
                    } else {
                        validate = $('#txtValidateNum').val();
                    }
                    if (data == $('#txtValidateNum').val().toUpperCase() || $('#ValidateNum1').css('display') == 'none') {
                        LoginWithValidate(validate);
                    } else {
                        alert('验证码输入错误');
                        location = 'Login.html';
                    }
                },
            });

        }

        function LoginWithValidate(validate) {
            var UserRoleArray = ["学生", "老师", "管理员"];
            var temp = parseInt(getCookie('times')) + 1;
            $.ajax({
                type: "get",
                url: '../api/Login?account=' + $('#txtAccount').val(),
                success: function(data) {
                    var t = data;
                    if (data == null) {
                        alert('用户名不存在');
                        location = 'Login.html';
                        return;
                    }
                    var list = {
                        '': $('#txtPwd').val()
                    };

                    $.ajax({
                        type: "post",
                        dataType: "html",
                        url: "../api/Login?account=" + $('#txtAccount').val(),
                        data: list,
                        success: function(data) {
                            if (data == 'true') {
                                alert('登陆成功');
                                deleteCookie('times');
                                var UserArray = {
                                    'UserID': t.UserID,
                                    'UserName': t.UserName,
                                    'Role': t.Role
                                };
                                alert(UserRoleArray[t.Role - 1] + "你好，欢迎登录");
                                resetJSONCookieExpires('User', UserArray, 3);
                                resetCookieExpires('islogin', 'true', 3);
                                location = 'Main.html';
                            } else {
                                resetCookie('times', temp);
                                alert('登录失败');
                                location = 'Login.html';
                            }
                        },
                        error: function(XMLHttpRequest, textStatus, errorThrown) {
                            ajaxError(XMLHttpRequest, textStatus);
                            resetCookie('times', temp);
                            location = 'Login.html';
                        }
                    });
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    ajaxError(XMLHttpRequest, textStatus);
                    resetCookie('times', temp);
                    location = 'Login.html';
                }
            });
        }

        function Register() {
            location = "Register.html";
        }
    </script>
</body>

</html>